Lab Example 1: Basic $lookup - Find All Enrollments with Student Details

// lab1-basic-lookup.js
// Basic $lookup - Join enrollments with student details

const mongoose = require('mongoose');

// MongoDB connection
const MONGODB_URI = 'mongodb+srv://username:password@cluster.mongodb.net/collegeDB?retryWrites=true&w=majority';

// Connect to MongoDB
mongoose.connect(MONGODB_URI);

// Define schemas
const enrollmentSchema = new mongoose.Schema({
    student: { type: mongoose.Schema.Types.ObjectId, ref: 'Student' },
    course: { type: mongoose.Schema.Types.ObjectId, ref: 'Course' },
    semester: String,
    grade: String
});

const studentSchema = new mongoose.Schema({
    studentId: String,
    name: String,
    email: String,
    program: String
});

const Enrollment = mongoose.model('Enrollment', enrollmentSchema);
const Student = mongoose.model('Student', studentSchema);

async function basicLookupExample() {
    try {
        console.log('🔍 Lab 1: Basic $lookup - Finding Enrollments with Student Details\n');
        
        // SQL Equivalent:
        // SELECT e.*, s.* 
        // FROM enrollments e
        // JOIN students s ON e.student_id = s._id
        
        const results = await Enrollment.aggregate([
            // Stage 1: $lookup - Join with students collection
            {
                $lookup: {
                    from: 'students',           // Collection to join
                    localField: 'student',      // Field in enrollments
                    foreignField: '_id',        // Field in students
                    as: 'studentDetails'        // Output array name
                }
            },
            
            // Stage 2: Limit results for readability
            {
                $limit: 3
            }
        ]);
        
        console.log('📊 Raw aggregation result (first enrollment):');
        console.log(JSON.stringify(results[0], null, 2));
        
        console.log('\n📋 Formatted results:');
        results.forEach((enrollment, index) => {
            console.log(`\nEnrollment ${index + 1}:`);
            console.log(`  Semester: ${enrollment.semester}`);
            console.log(`  Grade: ${enrollment.grade}`);
            console.log(`  Student Details:`, enrollment.studentDetails[0] ? {
                name: enrollment.studentDetails[0].name,
                studentId: enrollment.studentDetails[0].studentId,
                email: enrollment.studentDetails[0].email
            } : 'No student found');
        });
        
        console.log('\n💡 Key Learning Points:');
        console.log('1. $lookup creates an array field (studentDetails) even for 1:1 relationships');
        console.log('2. The "from" field uses the collection name (lowercase, plural)');
        console.log('3. This is similar to a LEFT JOIN - enrollments without students still appear');
        
    } catch (error) {
        console.error('❌ Error:', error.message);
    } finally {
        await mongoose.connection.close();
        console.log('\n✅ Connection closed');
    }
}

// Run the example
basicLookupExample();


Lab Example 2: $lookup with $unwind - Flattening the Join Results

// lab2-lookup-unwind.js
// $lookup with $unwind - Creating flat documents from joins

const mongoose = require('mongoose');

// MongoDB connection
const MONGODB_URI = 'mongodb+srv://username:password@cluster.mongodb.net/collegeDB?retryWrites=true&w=majority';

mongoose.connect(MONGODB_URI);

// Define schemas
const enrollmentSchema = new mongoose.Schema({
    student: { type: mongoose.Schema.Types.ObjectId, ref: 'Student' },
    course: { type: mongoose.Schema.Types.ObjectId, ref: 'Course' },
    semester: String,
    grade: String
});

const studentSchema = new mongoose.Schema({
    studentId: String,
    name: String,
    email: String,
    program: String
});

const courseSchema = new mongoose.Schema({
    courseCode: String,
    title: String,
    credits: Number,
    instructor: String
});

const Enrollment = mongoose.model('Enrollment', enrollmentSchema);
const Student = mongoose.model('Student', studentSchema);
const Course = mongoose.model('Course', courseSchema);

async function lookupWithUnwindExample() {
    try {
        console.log('🔍 Lab 2: $lookup with $unwind - Creating Flat Join Results\n');
        
        // SQL Equivalent:
        // SELECT s.name, s.studentId, c.courseCode, c.title, e.semester, e.grade
        // FROM enrollments e
        // JOIN students s ON e.student_id = s._id
        // JOIN courses c ON e.course_id = c._id
        // WHERE e.semester = 'Fall 2024'
        
        const results = await Enrollment.aggregate([
            // Stage 1: Filter for Fall 2024 (like WHERE clause)
            {
                $match: {
                    semester: 'Fall 2024'
                }
            },
            
            // Stage 2: Join with students
            {
                $lookup: {
                    from: 'students',
                    localField: 'student',
                    foreignField: '_id',
                    as: 'studentInfo'
                }
            },
            
            // Stage 3: Unwind student array (convert array to single object)
            {
                $unwind: '$studentInfo'
            },
            
            // Stage 4: Join with courses
            {
                $lookup: {
                    from: 'courses',
                    localField: 'course',
                    foreignField: '_id',
                    as: 'courseInfo'
                }
            },
            
            // Stage 5: Unwind course array
            {
                $unwind: '$courseInfo'
            },
            
            // Stage 6: Project (select) only the fields we want
            {
                $project: {
                    _id: 0,  // Exclude the _id
                    studentName: '$studentInfo.name',
                    studentId: '$studentInfo.studentId',
                    courseCode: '$courseInfo.courseCode',
                    courseTitle: '$courseInfo.title',
                    credits: '$courseInfo.credits',
                    semester: 1,  // Include semester
                    grade: 1      // Include grade
                }
            },
            
            // Stage 7: Sort by student name
            {
                $sort: {
                    studentName: 1
                }
            }
        ]);
        
        console.log('📊 Fall 2024 Enrollment Report:');
        console.log('='.repeat(80));
        console.log('Student Name         | Student ID | Course    | Title                          | Grade');
        console.log('-'.repeat(80));
        
        results.forEach(enrollment => {
            console.log(
                `${enrollment.studentName.padEnd(20)} | ` +
                `${enrollment.studentId.padEnd(10)} | ` +
                `${enrollment.courseCode.padEnd(9)} | ` +
                `${enrollment.courseTitle.padEnd(30)} | ` +
                `${enrollment.grade}`
            );
        });
        
        console.log('\n📈 Statistics:');
        console.log(`Total enrollments in Fall 2024: ${results.length}`);
        
        console.log('\n💡 Key Learning Points:');
        console.log('1. $unwind converts array fields into individual documents');
        console.log('2. After $unwind, you can access nested fields directly');
        console.log('3. $project reshapes documents - like SELECT in SQL');
        console.log('4. Use 1 to include fields, 0 to exclude in $project');
        console.log('5. Pipeline stages execute in order - $match first improves performance');
        
    } catch (error) {
        console.error('❌ Error:', error.message);
    } finally {
        await mongoose.connection.close();
    }
}

// Run the example
lookupWithUnwindExample();



Lab Example 3: Complex Predicate Joins - Students with Specific Grades

// lab3-predicate-joins.js
// Complex predicate joins - Finding high-performing students

const mongoose = require('mongoose');

// MongoDB connection
const MONGODB_URI = 'mongodb+srv://username:password@cluster.mongodb.net/collegeDB?retryWrites=true&w=majority';

mongoose.connect(MONGODB_URI);

// Define schemas
const enrollmentSchema = new mongoose.Schema({
    student: { type: mongoose.Schema.Types.ObjectId, ref: 'Student' },
    course: { type: mongoose.Schema.Types.ObjectId, ref: 'Course' },
    semester: String,
    grade: String
});

const studentSchema = new mongoose.Schema({
    studentId: String,
    name: String,
    email: String,
    program: String
});

const courseSchema = new mongoose.Schema({
    courseCode: String,
    title: String,
    credits: Number,
    instructor: String
});

const Enrollment = mongoose.model('Enrollment', enrollmentSchema);
const Student = mongoose.model('Student', studentSchema);
const Course = mongoose.model('Course', courseSchema);

async function predicateJoinExample() {
    try {
        console.log('🔍 Lab 3: Complex Predicate Joins - Finding Dean\'s List Students\n');
        
        // SQL Equivalent:
        // SELECT s.name, s.program, COUNT(*) as course_count, 
        //        GROUP_CONCAT(c.courseCode) as courses
        // FROM students s
        // JOIN enrollments e ON s._id = e.student_id
        // JOIN courses c ON c._id = e.course_id
        // WHERE e.grade IN ('A', 'A+', 'A-')
        // GROUP BY s._id, s.name, s.program
        // HAVING COUNT(*) >= 2
        
        const results = await Student.aggregate([
            // Stage 1: Start with students (different approach - start from students)
            {
                $lookup: {
                    from: 'enrollments',
                    let: { studentId: '$_id' },  // Variable from students
                    pipeline: [
                        // Sub-pipeline inside $lookup
                        {
                            $match: {
                                $expr: {
                                    $and: [
                                        { $eq: ['$student', '$$studentId'] },  // Join condition
                                        { $in: ['$grade', ['A+', 'A', 'A-']] }  // Grade predicate
                                    ]
                                }
                            }
                        }
                    ],
                    as: 'highGradeEnrollments'
                }
            },
            
            // Stage 2: Filter students with at least 2 A grades
            {
                $match: {
                    $expr: {
                        $gte: [{ $size: '$highGradeEnrollments' }, 2]
                    }
                }
            },
            
            // Stage 3: Join with courses for each enrollment
            {
                $lookup: {
                    from: 'courses',
                    let: { 
                        enrollments: '$highGradeEnrollments'
                    },
                    pipeline: [
                        {
                            $match: {
                                $expr: {
                                    $in: ['$_id', '$$enrollments.course']
                                }
                            }
                        }
                    ],
                    as: 'courses'
                }
            },
            
            // Stage 4: Create the final report
            {
                $project: {
                    _id: 0,
                    studentName: '$name',
                    studentId: '$studentId',
                    program: 1,
                    excellentGrades: { $size: '$highGradeEnrollments' },
                    courseCodes: {
                        $map: {
                            input: '$courses',
                            as: 'course',
                            in: '$$course.courseCode'
                        }
                    },
                    gradeDetails: {
                        $map: {
                            input: '$highGradeEnrollments',
                            as: 'enrollment',
                            in: {
                                grade: '$$enrollment.grade',
                                semester: '$$enrollment.semester'
                            }
                        }
                    }
                }
            },
            
            // Stage 5: Sort by number of excellent grades
            {
                $sort: {
                    excellentGrades: -1,
                    studentName: 1
                }
            }
        ]);
        
        console.log('🏆 Dean\'s List Report - Students with 2+ Excellent Grades (A-, A, A+)');
        console.log('='.repeat(80));
        
        results.forEach((student, index) => {
            console.log(`\n${index + 1}. ${student.studentName} (${student.studentId})`);
            console.log(`   Program: ${student.program}`);
            console.log(`   Excellent Grades: ${student.excellentGrades}`);
            console.log(`   Courses: ${student.courseCodes.join(', ')}`);
            console.log(`   Grade Details:`);
            student.gradeDetails.forEach(detail => {
                console.log(`     - ${detail.grade} in ${detail.semester}`);
            });
        });
        
        console.log('\n💡 Key Learning Points:');
        console.log('1. $lookup can have a sub-pipeline for complex join conditions');
        console.log('2. Use "let" to pass variables into the sub-pipeline');
        console.log('3. $$variable (double $) references variables from "let"');
        console.log('4. $expr allows complex expressions in $match');
        console.log('5. This is equivalent to SQL JOIN with WHERE conditions');
        console.log('6. $map transforms arrays - like Array.map() in JavaScript');
        
    } catch (error) {
        console.error('❌ Error:', error.message);
    } finally {
        await mongoose.connection.close();
    }
}

// Run the example
predicateJoinExample();



Lab Example 4: Aggregation with $group - Course Statistics

// lab4-group-statistics.js
// Using $group with $lookup - Course enrollment statistics

const mongoose = require('mongoose');

// MongoDB connection
const MONGODB_URI = 'mongodb+srv://username:password@cluster.mongodb.net/collegeDB?retryWrites=true&w=majority';

mongoose.connect(MONGODB_URI);

// Define schemas
const enrollmentSchema = new mongoose.Schema({
    student: { type: mongoose.Schema.Types.ObjectId, ref: 'Student' },
    course: { type: mongoose.Schema.Types.ObjectId, ref: 'Course' },
    semester: String,
    grade: String
});

const courseSchema = new mongoose.Schema({
    courseCode: String,
    title: String,
    credits: Number,
    instructor: String,
    maxStudents: Number
});

const Enrollment = mongoose.model('Enrollment', enrollmentSchema);
const Course = mongoose.model('Course', courseSchema);

async function groupStatisticsExample() {
    try {
        console.log('🔍 Lab 4: Aggregation with $group - Course Statistics Report\n');
        
        // SQL Equivalent:
        // SELECT c.courseCode, c.title, c.instructor, c.maxStudents,
        //        COUNT(e.student_id) as enrolled,
        //        COUNT(CASE WHEN e.grade = 'Withdrawn' THEN 1 END) as withdrawn,
        //        AVG(CASE grade calculations...) as avg_gpa
        // FROM courses c
        // LEFT JOIN enrollments e ON c._id = e.course_id
        // GROUP BY c._id, c.courseCode, c.title, c.instructor
        
        const results = await Course.aggregate([
            // Stage 1: Join with enrollments
            {
                $lookup: {
                    from: 'enrollments',
                    localField: '_id',
                    foreignField: 'course',
                    as: 'enrollments'
                }
            },
            
            // Stage 2: Add calculated fields for each course
            {
                $addFields: {
                    // Total enrolled (excluding withdrawn)
                    totalEnrolled: {
                        $size: {
                            $filter: {
                                input: '$enrollments',
                                as: 'enrollment',
                                cond: { $ne: ['$$enrollment.grade', 'Withdrawn'] }
                            }
                        }
                    },
                    
                    // Count withdrawn students
                    withdrawnCount: {
                        $size: {
                            $filter: {
                                input: '$enrollments',
                                as: 'enrollment',
                                cond: { $eq: ['$$enrollment.grade', 'Withdrawn'] }
                            }
                        }
                    },
                    
                    // Calculate capacity percentage
                    capacityUsed: {
                        $multiply: [
                            {
                                $divide: [
                                    {
                                        $size: {
                                            $filter: {
                                                input: '$enrollments',
                                                as: 'e',
                                                cond: { $ne: ['$$e.grade', 'Withdrawn'] }
                                            }
                                        }
                                    },
                                    '$maxStudents'
                                ]
                            },
                            100
                        ]
                    },
                    
                    // Group enrollments by semester
                    semesterBreakdown: {
                        $reduce: {
                            input: '$enrollments',
                            initialValue: {},
                            in: {
                                $mergeObjects: [
                                    '$$value',
                                    {
                                        $cond: [
                                            { $ne: ['$$this.grade', 'Withdrawn'] },
                                            {
                                                $literal: {
                                                    $concat: ['$$this.semester']
                                                }
                                            },
                                            {}
                                        ]
                                    }
                                ]
                            }
                        }
                    }
                }
            },
            
            // Stage 3: Calculate grade distribution
            {
                $addFields: {
                    gradeDistribution: {
                        A: {
                            $size: {
                                $filter: {
                                    input: '$enrollments',
                                    cond: { $in: ['$$this.grade', ['A+', 'A', 'A-']] }
                                }
                            }
                        },
                        B: {
                            $size: {
                                $filter: {
                                    input: '$enrollments',
                                    cond: { $in: ['$$this.grade', ['B+', 'B', 'B-']] }
                                }
                            }
                        },
                        C: {
                            $size: {
                                $filter: {
                                    input: '$enrollments',
                                    cond: { $in: ['$$this.grade', ['C+', 'C', 'C-']] }
                                }
                            }
                        },
                        DF: {
                            $size: {
                                $filter: {
                                    input: '$enrollments',
                                    cond: { $in: ['$$this.grade', ['D', 'F']] }
                                }
                            }
                        },
                        InProgress: {
                            $size: {
                                $filter: {
                                    input: '$enrollments',
                                    cond: { $eq: ['$$this.grade', 'In Progress'] }
                                }
                            }
                        }
                    }
                }
            },
            
            // Stage 4: Project final output
            {
                $project: {
                    _id: 0,
                    courseCode: 1,
                    title: 1,
                    instructor: 1,
                    credits: 1,
                    maxStudents: 1,
                    totalEnrolled: 1,
                    withdrawnCount: 1,
                    capacityUsed: { $round: ['$capacityUsed', 1] },
                    availableSeats: { $subtract: ['$maxStudents', '$totalEnrolled'] },
                    gradeDistribution: 1,
                    status: {
                        $switch: {
                            branches: [
                                { case: { $gte: ['$capacityUsed', 100] }, then: 'FULL' },
                                { case: { $gte: ['$capacityUsed', 80] }, then: 'Nearly Full' },
                                { case: { $gte: ['$capacityUsed', 50] }, then: 'Available' },
                                { case: { $lt: ['$capacityUsed', 50] }, then: 'Many Seats' }
                            ],
                            default: 'Unknown'
                        }
                    }
                }
            },
            
            // Stage 5: Sort by capacity used (descending)
            {
                $sort: {
                    capacityUsed: -1
                }
            }
        ]);
        
        console.log('📊 Course Enrollment Statistics Report');
        console.log('='.repeat(100));
        
        results.forEach(course => {
            console.log(`\n📚 ${course.courseCode}: ${course.title}`);
            console.log(`   Instructor: ${course.instructor} | Credits: ${course.credits}`);
            console.log(`   Enrollment: ${course.totalEnrolled}/${course.maxStudents} (${course.capacityUsed}% full) - ${course.status}`);
            console.log(`   Available Seats: ${course.availableSeats}`);
            console.log(`   Withdrawn: ${course.withdrawnCount}`);
            
            console.log(`   Grade Distribution:`);
            console.log(`     A's: ${course.gradeDistribution.A} | B's: ${course.gradeDistribution.B} | ` +
                       `C's: ${course.gradeDistribution.C} | D/F: ${course.gradeDistribution.DF} | ` +
                       `In Progress: ${course.gradeDistribution.InProgress}`);
        });
        
        // Summary statistics using $group
        const summary = await Course.aggregate([
            {
                $lookup: {
                    from: 'enrollments',
                    localField: '_id',
                    foreignField: 'course',
                    as: 'enrollments'
                }
            },
            {
                $group: {
                    _id: null,
                    totalCourses: { $sum: 1 },
                    totalSeats: { $sum: '$maxStudents' },
                    totalEnrollments: {
                        $sum: {
                            $size: {
                                $filter: {
                                    input: '$enrollments',
                                    cond: { $ne: ['$$this.grade', 'Withdrawn'] }
                                }
                            }
                        }
                    },
                    avgClassSize: {
                        $avg: {
                            $size: {
                                $filter: {
                                    input: '$enrollments',
                                    cond: { $ne: ['$$this.grade', 'Withdrawn'] }
                                }
                            }
                        }
                    }
                }
            }
        ]);
        
        console.log('\n📈 Overall Summary:');
        if (summary[0]) {
            console.log(`   Total Courses: ${summary[0].totalCourses}`);
            console.log(`   Total Seats Available: ${summary[0].totalSeats}`);
            console.log(`   Total Enrollments: ${summary[0].totalEnrollments}`);
            console.log(`   Average Class Size: ${summary[0].avgClassSize.toFixed(1)}`);
            console.log(`   Overall Capacity: ${((summary[0].totalEnrollments / summary[0].totalSeats) * 100).toFixed(1)}%`);
        }
        
        console.log('\n💡 Key Learning Points:');
        console.log('1. $filter creates subsets of arrays based on conditions');
        console.log('2. $addFields adds computed fields without removing existing ones');
        console.log('3. $switch is like a switch statement for conditional logic');
        console.log('4. $group aggregates multiple documents into summary documents');
        console.log('5. Complex calculations can be done within the aggregation pipeline');
        
    } catch (error) {
        console.error('❌ Error:', error.message);
    } finally {
        await mongoose.connection.close();
    }
}

// Run the example
groupStatisticsExample();



Lab Example 5: Advanced Multi-Collection Join - Student Transcripts

// lab5-student-transcripts.js
// Advanced multi-collection join - Complete student transcripts with GPA

const mongoose = require('mongoose');

// MongoDB connection
const MONGODB_URI = 'mongodb+srv://username:password@cluster.mongodb.net/collegeDB?retryWrites=true&w=majority';

mongoose.connect(MONGODB_URI);

// Define schemas
const studentSchema = new mongoose.Schema({
    studentId: String,
    name: String,
    email: String,
    program: String
});

const enrollmentSchema = new mongoose.Schema({
    student: { type: mongoose.Schema.Types.ObjectId, ref: 'Student' },
    course: { type: mongoose.Schema.Types.ObjectId, ref: 'Course' },
    semester: String,
    grade: String
});

const courseSchema = new mongoose.Schema({
    courseCode: String,
    title: String,
    credits: Number,
    instructor: String
});

const Student = mongoose.model('Student', studentSchema);
const Enrollment = mongoose.model('Enrollment', enrollmentSchema);
const Course = mongoose.model('Course', courseSchema);

async function studentTranscriptExample() {
    try {
        console.log('🔍 Lab 5: Advanced Multi-Collection Join - Student Transcripts with GPA\n');
        
        // This is equivalent to a complex SQL query with multiple JOINs,
        // GROUP BY, and calculated fields
        
        // Get a specific student's ID first
        const targetStudent = await Student.findOne({ studentId: 'S10001' });
        
        if (!targetStudent) {
            console.log('Student S10001 not found. Using first available student...');
            const firstStudent = await Student.findOne();
            if (!firstStudent) {
                console.log('No students found in database!');
                return;
            }
            targetStudent._id = firstStudent._id;
        }
        
        const transcripts = await Student.aggregate([
            // Stage 1: Match specific student (or remove this for all students)
            {
                $match: {
                    _id: targetStudent._id
                }
            },
            
            // Stage 2: Join with enrollments
            {
                $lookup: {
                    from: 'enrollments',
                    let: { studentId: '$_id' },
                    pipeline: [
                        {
                            $match: {
                                $expr: { $eq: ['$student', '$$studentId'] }
                            }
                        },
                        // Sub-pipeline: Join each enrollment with course details
                        {
                            $lookup: {
                                from: 'courses',
                                localField: 'course',
                                foreignField: '_id',
                                as: 'courseDetails'
                            }
                        },
                        {
                            $unwind: '$courseDetails'
                        },
                        // Calculate grade points for each course
                        {
                            $addFields: {
                                gradePoint: {
                                    $switch: {
                                        branches: [
                                            { case: { $eq: ['$grade', 'A+'] }, then: 4.0 },
                                            { case: { $eq: ['$grade', 'A'] }, then: 4.0 },
                                            { case: { $eq: ['$grade', 'A-'] }, then: 3.7 },
                                            { case: { $eq: ['$grade', 'B+'] }, then: 3.3 },
                                            { case: { $eq: ['$grade', 'B'] }, then: 3.0 },
                                            { case: { $eq: ['$grade', 'B-'] }, then: 2.7 },
                                            { case: { $eq: ['$grade', 'C+'] }, then: 2.3 },
                                            { case: { $eq: ['$grade', 'C'] }, then: 2.0 },
                                            { case: { $eq: ['$grade', 'C-'] }, then: 1.7 },
                                            { case: { $eq: ['$grade', 'D'] }, then: 1.0 },
                                            { case: { $eq: ['$grade', 'F'] }, then: 0 }
                                        ],
                                        default: null  // For 'In Progress' or 'Withdrawn'
                                    }
                                },
                                qualityPoints: {
                                    $cond: {
                                        if: { $in: ['$grade', ['In Progress', 'Withdrawn']] },
                                        then: 0,
                                        else: {
                                            $multiply: [
                                                '$courseDetails.credits',
                                                {
                                                    $switch: {
                                                        branches: [
                                                            { case: { $eq: ['$grade', 'A+'] }, then: 4.0 },
                                                            { case: { $eq: ['$grade', 'A'] }, then: 4.0 },
                                                            { case: { $eq: ['$grade', 'A-'] }, then: 3.7 },
                                                            { case: { $eq: ['$grade', 'B+'] }, then: 3.3 },
                                                            { case: { $eq: ['$grade', 'B'] }, then: 3.0 },
                                                            { case: { $eq: ['$grade', 'B-'] }, then: 2.7 },
                                                            { case: { $eq: ['$grade', 'C+'] }, then: 2.3 },
                                                            { case: { $eq: ['$grade', 'C'] }, then: 2.0 },
                                                            { case: { $eq: ['$grade', 'C-'] }, then: 1.7 },
                                                            { case: { $eq: ['$grade', 'D'] }, then: 1.0 },
                                                            { case: { $eq: ['$grade', 'F'] }, then: 0 }
                                                        ],
                                                        default: 0
                                                    }
                                                }
                                            ]
                                        }
                                    }
                                }
                            }
                        }
                    ],
                    as: 'enrollmentHistory'
                }
            },
            
            // Stage 3: Calculate transcript summary
            {
                $addFields: {
                    // Separate completed courses from in-progress
                    completedCourses: {
                        $filter: {
                            input: '$enrollmentHistory',
                            as: 'enrollment',
                            cond: {
                                $not: {
                                    $in: ['$$enrollment.grade', ['In Progress', 'Withdrawn']]
                                }
                            }
                        }
                    },
                    inProgressCourses: {
                        $filter: {
                            input: '$enrollmentHistory',
                            as: 'enrollment',
                            cond: { $eq: ['$$enrollment.grade', 'In Progress'] }
                        }
                    },
                    
                    // Group by semester
                    semesterGroups: {
                        $reduce: {
                            input: '$enrollmentHistory',
                            initialValue: [],
                            in: {
                                $cond: {
                                    if: { $in: ['$$this.semester', '$$value.semester'] },
                                    then: '$$value',
                                    else: { $concatArrays: ['$$value', [{ semester: '$$this.semester' }]] }
                                }
                            }
                        }
                    }
                }
            },
            
            // Stage 4: Calculate GPA and other metrics
            {
                $addFields: {
                    totalCreditsAttempted: {
                        $sum: {
                            $map: {
                                input: '$completedCourses',
                                as: 'course',
                                in: '$$course.courseDetails.credits'
                            }
                        }
                    },
                    totalQualityPoints: {
                        $sum: {
                            $map: {
                                input: '$completedCourses',
                                as: 'course',
                                in: '$$course.qualityPoints'
                            }
                        }
                    },
                    currentCredits: {
                        $sum: {
                            $map: {
                                input: '$inProgressCourses',
                                as: 'course',
                                in: '$$course.courseDetails.credits'
                            }
                        }
                    }
                }
            },
            
            // Stage 5: Final projection with GPA calculation
            {
                $project: {
                    studentInfo: {
                        studentId: '$studentId',
                        name: '$name',
                        email: '$email',
                        program: '$program'
                    },
                    academicSummary: {
                        totalCreditsCompleted: '$totalCreditsAttempted',
                        currentlyEnrolledCredits: '$currentCredits',
                        cumulativeGPA: {
                            $cond: {
                                if: { $eq: ['$totalCreditsAttempted', 0] },
                                then: 0,
                                else: {
                                    $round: [
                                        { $divide: ['$totalQualityPoints', '$totalCreditsAttempted'] },
                                        2
                                    ]
                                }
                            }
                        },
                        totalCourses: { $size: '$enrollmentHistory' },
                        completedCourses: { $size: '$completedCourses' },
                        inProgressCourses: { $size: '$inProgressCourses' }
                    },
                    courseHistory: {
                        $map: {
                            input: '$enrollmentHistory',
                            as: 'enrollment',
                            in: {
                                semester: '$$enrollment.semester',
                                courseCode: '$$enrollment.courseDetails.courseCode',
                                courseTitle: '$$enrollment.courseDetails.title',
                                credits: '$$enrollment.courseDetails.credits',
                                instructor: '$$enrollment.courseDetails.instructor',
                                grade: '$$enrollment.grade',
                                gradePoints: '$$enrollment.gradePoint'
                            }
                        }
                    }
                }
            }
        ]);
        
        // Display the transcript
        if (transcripts.length > 0) {
            const transcript = transcripts[0];
            
            console.log('📜 OFFICIAL TRANSCRIPT');
            console.log('='.repeat(80));
            console.log(`Student: ${transcript.studentInfo.name}`);
            console.log(`ID: ${transcript.studentInfo.studentId}`);
            console.log(`Email: ${transcript.studentInfo.email}`);
            console.log(`Program: ${transcript.studentInfo.program}`);
            console.log('-'.repeat(80));
            
            console.log('\n📊 Academic Summary:');
            console.log(`Cumulative GPA: ${transcript.academicSummary.cumulativeGPA}`);
            console.log(`Total Credits Completed: ${transcript.academicSummary.totalCreditsCompleted}`);
            console.log(`Currently Enrolled Credits: ${transcript.academicSummary.currentlyEnrolledCredits}`);
            console.log(`Courses Completed: ${transcript.academicSummary.completedCourses}`);
            console.log(`Courses In Progress: ${transcript.academicSummary.inProgressCourses}`);
            
            console.log('\n📚 Course History:');
            console.log('-'.repeat(80));
            
            // Group courses by semester for display
            const coursesBySemester = {};
            transcript.courseHistory.forEach(course => {
                if (!coursesBySemester[course.semester]) {
                    coursesBySemester[course.semester] = [];
                }
                coursesBySemester[course.semester].push(course);
            });
            
            Object.keys(coursesBySemester).sort().forEach(semester => {
                console.log(`\n${semester}:`);
                coursesBySemester[semester].forEach(course => {
                    const gradePoints = course.gradePoints !== null ? course.gradePoints.toFixed(1) : 'N/A';
                    console.log(
                        `  ${course.courseCode.padEnd(10)} | ` +
                        `${course.courseTitle.padEnd(35)} | ` +
                        `${course.credits} credits | ` +
                        `Grade: ${course.grade.padEnd(11)} | ` +
                        `Points: ${gradePoints}`
                    );
                });
            });
        }
        
        console.log('\n💡 Key Learning Points:');
        console.log('1. Nested $lookup allows joining multiple collections in sub-pipelines');
        console.log('2. $reduce can create complex data structures during aggregation');
        console.log('3. $map transforms arrays similar to JavaScript Array.map()');
        console.log('4. Complex GPA calculations can be done entirely in the pipeline');
        console.log('5. This single aggregation replaces multiple SQL queries with JOINs');
        console.log('6. Sub-pipelines in $lookup can have their own multi-stage logic');
        
    } catch (error) {
        console.error('❌ Error:', error.message);
    } finally {
        await mongoose.connection.close();
    }
}

// Run the example
studentTranscriptExample();




Summary: MongoDB Aggregation Best Practices
Key Concepts to Remember:

Pipeline Order Matters

Put $match early to filter documents
This reduces the data flowing through subsequent stages


$lookup vs populate()

populate() is simpler but limited
$lookup in aggregation is more powerful and flexible


Handling Arrays from $lookup

$lookup always returns an array
Use $unwind to flatten 1:1 relationships
Use $filter to work with array elements


Performance Tips

Create indexes on fields used in localField and foreignField
Use $project to limit fields early in the pipeline
Consider using allowDiskUse: true for large datasets



